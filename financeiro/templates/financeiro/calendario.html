{% extends 'financeiro/base_financeiro.html' %}
{% load static %}

{% block page_title %}Calendário de Reservas{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <a href="{% url 'financeiro:dashboard' %}" class="btn btn-outline-secondary">Voltar para Dashboard</a>
    <a href="{% url 'reservas:criar' %}" class="btn btn-primary">Nova Reserva</a>
</div>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.css" rel="stylesheet">
<style>
    #calendar {
        background-color: #fff;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .fc-event {
        cursor: pointer;
        border-left-width: 5px !important;
    }
    
    .fc-event-title {
        font-weight: bold;
        font-size: 0.85em;
        padding: 2px;
    }
    
    .fc-daygrid-event-dot {
        display: none; /* Remove os pontos dos eventos */
    }
    
    /* Cores de status específicas */
    .status-pendente {
        opacity: 0.85;
        background-color: #f9c851 !important;
        color: #333 !important;
        border-color: #e6b325 !important;
    }
    
    .status-confirmada {
        opacity: 0.9;
        background-color: #34c38f !important;
        color: #fff !important;
        border-color: #2aa176 !important;
    }
    
    .status-em_andamento {
        opacity: 0.95;
        background-color: #556ee6 !important;
        color: #fff !important;
        border-color: #3a57d2 !important;
        font-weight: bold;
    }
    
    .status-concluida {
        opacity: 0.75;
        background-color: #74788d !important;
        color: #fff !important;
        border-color: #5d6072 !important;
    }
    
    .status-cancelada {
        opacity: 0.7;
        background-color: #f46a6a !important;
        color: #fff !important;
        border-color: #e45151 !important;
        text-decoration: line-through;
    }
    
    .status-no_show {
        opacity: 0.7;
        background-color: #343a40 !important;
        color: #fff !important;
        border-color: #23272b !important;
    }
    
    .fc-toolbar-title {
        font-size: 1.5rem !important;
    }
    
    .fc-daygrid-day.fc-day-today {
        background-color: rgba(52, 195, 143, 0.1) !important;
    }
    
    .reservation-details {
        font-size: 0.9rem;
    }
    
    .reservation-details ul {
        list-style: none;
        padding-left: 0;
    }
    
    .reservation-details ul li {
        margin-bottom: 8px;
        display: flex;
    }
    
    .reservation-details ul li i {
        width: 20px;
        text-align: center;
        margin-right: 10px;
    }
    
    #reservationModal .modal-header {
        border-radius: 0;
    }
    
    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .legend {
        margin-top: 15px;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-right: 10px;
        font-size: 0.8rem;
    }
    
    .legend-color {
        width: 15px;
        height: 15px;
        border-radius: 3px;
        margin-right: 5px;
    }
    
    /* Ajustes para modo responsivo */
    @media (max-width: 768px) {
        .fc-event-title {
            font-size: 0.75em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    }
    
    .fc-daygrid-day.has-reservations {
        background-color: rgba(85, 110, 230, 0.1) !important;
        position: relative;
    }
    
    .reservation-count {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: #556ee6;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block financeiro_content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0 text-gray-800">Calendário de Reservas</h1>
            <p class="text-muted">Visualize as reservas e ocupações por data</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Calendário</h6>
                    <div>
                        <button class="btn btn-sm btn-primary" id="btnHoje">
                            <i class="fas fa-calendar-day"></i> Hoje
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="calendario"></div>
                    
                    <div class="legend mt-3">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #f9c851;"></div>
                            <span>Pendente</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #34c38f;"></div>
                            <span>Confirmada</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #556ee6;"></div>
                            <span>Check-in</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #74788d;"></div>
                            <span>Concluída</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #f46a6a;"></div>
                            <span>Cancelada</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #343a40;"></div>
                            <span>No-show</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal fade" id="modalDetalhes" tabindex="-1" aria-labelledby="modalDetalhesLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetalhesLabel">Detalhes do Dia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="detalhesDia"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Cancelamento -->
<div class="modal fade" id="modalCancelar" tabindex="-1" aria-labelledby="modalCancelarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalCancelarLabel">Cancelar Reserva</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formCancelar">
                    <input type="hidden" id="cancelarCodigo">
                    <div class="mb-3">
                        <label for="motivoCancelamento" class="form-label">Motivo do Cancelamento</label>
                        <textarea class="form-control" id="motivoCancelamento" rows="3" required></textarea>
                    </div>
                </form>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Atenção: Esta ação não pode ser desfeita. A reserva será marcada como cancelada.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarCancelamento">
                    <i class="fas fa-times-circle"></i> Confirmar Cancelamento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Check-out -->
<div class="modal fade" id="modalCheckout" tabindex="-1" aria-labelledby="modalCheckoutLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalCheckoutLabel">Realizar Check-out</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formCheckout">
                    <input type="hidden" id="checkoutCodigo">
                    <div class="mb-3">
                        <label for="observacoesCheckout" class="form-label">Observações (opcional)</label>
                        <textarea class="form-control" id="observacoesCheckout" rows="3"></textarea>
                    </div>
                </form>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    O quarto será marcado como disponível e uma tarefa de limpeza será automaticamente criada.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarCheckout">
                    <i class="fas fa-check-circle"></i> Confirmar Check-out
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Pagamento -->
<div class="modal fade" id="modalPagamento" tabindex="-1" aria-labelledby="modalPagamentoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalPagamentoLabel">Registrar Pagamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formPagamento">
                    <input type="hidden" id="pagamentoCodigoReserva">
                    
                    <div class="alert alert-info mb-3" id="infoPagamento">
                        <div><strong>Hóspede:</strong> <span id="pagamentoHospede"></span></div>
                        <div><strong>Quarto:</strong> <span id="pagamentoQuarto"></span></div>
                        <div><strong>Período:</strong> <span id="pagamentoPeriodo"></span></div>
                        <div class="mt-2">
                            <strong>Valor Total:</strong> R$ <span id="pagamentoValorTotal">0.00</span>
                        </div>
                        <div>
                            <strong>Já Pago:</strong> R$ <span id="pagamentoValorPago">0.00</span>
                        </div>
                        <div>
                            <strong>Pendente:</strong> R$ <span id="pagamentoValorPendente">0.00</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="valorPagamento" class="form-label">Valor do Pagamento (R$)</label>
                        <input type="number" step="0.01" min="0.01" class="form-control" id="valorPagamento" required>
                        <div class="form-text">Valor máximo: R$ <span id="maxValorPagamento">0.00</span></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="formaPagamento" class="form-label">Forma de Pagamento</label>
                        <select class="form-select" id="formaPagamento" required>
                            <option value="">Selecione...</option>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="cartao_credito">Cartão de Crédito</option>
                            <option value="cartao_debito">Cartão de Débito</option>
                            <option value="pix">PIX</option>
                            <option value="transferencia">Transferência Bancária</option>
                            <option value="deposito">Depósito Bancário</option>
                            <option value="outros">Outros</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoesPagamento" class="form-label">Observações (opcional)</label>
                        <textarea class="form-control" id="observacoesPagamento" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmarPagamento">
                    <i class="fas fa-check"></i> Confirmar Pagamento
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block financeiro_js %}
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.0/locales/pt-br.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendario');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'pt-br',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: function(info, successCallback, failureCallback) {
                // Busca eventos do backend
                fetch(`/reservas/eventos-calendario/?start=${info.startStr}&end=${info.endStr}`)
                    .then(response => response.json())
                    .then(data => {
                        successCallback(data);
                        
                        // Método alternativo para destacar dias com reservas após carregar os eventos
                        setTimeout(destacarDiasComReservas, 100);
                    })
                    .catch(error => {
                        failureCallback(error);
                    });
            },
            eventDidMount: function(info) {
                // Adiciona tooltip com informações detalhadas
                var tooltip = new bootstrap.Tooltip(info.el, {
                    title: function() {
                        var evento = info.event;
                        var status = evento.extendedProps.status;
                        var statusClass = evento.classNames ? evento.classNames[0] : '';
                        
                        var html = `
                            <div class="tooltip-content">
                                <div class="tooltip-header mb-2 d-flex justify-content-between align-items-center">
                                    <h6 class="m-0">Quarto ${evento.extendedProps.quarto.split(' ')[1]}</h6>
                                    <span class="badge ${statusClass.replace('status-', 'bg-')}">${status}</span>
                                </div>
                                <div class="tooltip-body">
                                    <p><i class="fas fa-user"></i> <strong>Hóspede:</strong> ${evento.extendedProps.hospede}</p>
                                    <p><i class="fas fa-hashtag"></i> <strong>Reserva:</strong> ${evento.extendedProps.codigo}</p>
                                    <p><i class="fas fa-calendar-check"></i> <strong>Check-in:</strong> ${evento.extendedProps.check_in}</p>
                                    <p><i class="fas fa-calendar-times"></i> <strong>Check-out:</strong> ${evento.extendedProps.check_out}</p>
                                </div>
                                <div class="tooltip-footer mt-2 pt-2 border-top">
                                    <small>Clique no dia para ver detalhes e ações</small>
                                </div>
                            </div>
                        `;
                        return html;
                    },
                    html: true,
                    placement: 'top',
                    trigger: 'hover',
                    container: 'body'
                });
            },
            dateClick: function(info) {
                // Mostra modal com detalhes do dia
                var modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
                var detalhesDia = document.getElementById('detalhesDia');
                
                // Busca detalhes do dia
                fetch(`/reservas/detalhes-dia/?data=${info.dateStr}`)
                    .then(response => response.json())
                    .then(data => {
                        var html = `
                            <div class="list-group">
                                <h6 class="mb-3">Reservas para ${formatarData(info.dateStr)}</h6>
                                ${data.reservas.length === 0 ? 
                                    '<div class="alert alert-info">Não há reservas para esta data.</div>' : 
                                    data.reservas.map(reserva => `
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between mb-2">
                                            <h6 class="mb-1">${reserva.hospede}</h6>
                                            <span class="badge bg-${mapStatusToColor(reserva.status_raw)}">${reserva.status}</span>
                                        </div>
                                        <p class="mb-1">Quarto: ${reserva.quarto}</p>
                                        <p class="mb-1">Check-in: ${reserva.check_in} | Check-out: ${reserva.check_out}</p>
                                        
                                        <div class="btn-group mt-2" role="group">
                                            ${getBotoesPorStatus(reserva)}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        detalhesDia.innerHTML = html;
                        
                        // Adicionar event listeners para os botões
                        adicionarEventListeners();
                        
                        modal.show();
                    });
            }
        });
        calendar.render();

        // Botão "Hoje"
        document.getElementById('btnHoje').addEventListener('click', function() {
            calendar.gotoDate(new Date());
        });
        
        // Mapeamento de cores
        function mapStatusToColor(status) {
            const map = {
                'pendente': 'warning',
                'confirmada': 'primary',
                'em_andamento': 'info',
                'concluida': 'success',
                'cancelada': 'danger',
                'no_show': 'secondary'
            };
            return map[status] || 'secondary';
        }
        
        // Formatar data
        function formatarData(dataStr) {
            const data = new Date(dataStr);
            return data.toLocaleDateString('pt-BR', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
        
        // Obter botões baseado no status da reserva
        function getBotoesPorStatus(reserva) {
            let botoes = '';
            
            // Botão de detalhes para todos os status
            botoes += `<a href="/reservas/confirmada/${reserva.codigo}/" class="btn btn-sm btn-outline-primary" title="Ver detalhes">
                <i class="fas fa-eye"></i> Detalhes
            </a>`;
            
            // Botão de cancelar para reservas pendentes, confirmadas ou em andamento
            if (['pendente', 'confirmada', 'em_andamento'].includes(reserva.status_raw)) {
                botoes += `<button type="button" class="btn btn-sm btn-outline-danger btn-cancelar" 
                    data-codigo="${reserva.codigo}" title="Cancelar reserva">
                    <i class="fas fa-times"></i> Cancelar
                </button>`;
            }
            
            // Botão de checkout apenas para reservas que podem ter checkout
            if (reserva.pode_checkout) {
                botoes += `<button type="button" class="btn btn-sm btn-outline-success btn-checkout" 
                    data-codigo="${reserva.codigo}" title="Realizar check-out">
                    <i class="fas fa-sign-out-alt"></i> Check-out
                </button>`;
            }
            
            return botoes;
        }
        
        // Adicionar event listeners para os botões
        function adicionarEventListeners() {
            // Event listeners para botões de cancelar
            document.querySelectorAll('.btn-cancelar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const codigo = this.getAttribute('data-codigo');
                    document.getElementById('cancelarCodigo').value = codigo;
                    
                    const modalCancelar = new bootstrap.Modal(document.getElementById('modalCancelar'));
                    modalCancelar.show();
                });
            });
            
            // Event listeners para botões de checkout
            document.querySelectorAll('.btn-checkout').forEach(btn => {
                btn.addEventListener('click', function() {
                    const codigo = this.getAttribute('data-codigo');
                    document.getElementById('checkoutCodigo').value = codigo;
                    
                    const modalCheckout = new bootstrap.Modal(document.getElementById('modalCheckout'));
                    modalCheckout.show();
                });
            });
            
            // Event listeners para botões de registrar pagamento
            document.querySelectorAll('.btn-registrar-pagamento').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modalDetalhes = bootstrap.Modal.getInstance(document.getElementById('modalDetalhes'));
                    if (modalDetalhes) {
                        modalDetalhes.hide();
                    }
                    
                    const codigo = this.getAttribute('data-reserva');
                    const hospede = this.getAttribute('data-hospede');
                    const quarto = this.getAttribute('data-quarto');
                    const periodo = this.getAttribute('data-periodo');
                    const total = parseFloat(this.getAttribute('data-total'));
                    const pago = parseFloat(this.getAttribute('data-pago'));
                    const pendente = parseFloat(this.getAttribute('data-pendente'));
                    
                    // Preenche o modal com os dados da reserva
                    document.getElementById('pagamentoCodigoReserva').value = codigo;
                    document.getElementById('pagamentoHospede').textContent = hospede;
                    document.getElementById('pagamentoQuarto').textContent = quarto;
                    document.getElementById('pagamentoPeriodo').textContent = periodo;
                    document.getElementById('pagamentoValorTotal').textContent = total.toFixed(2);
                    document.getElementById('pagamentoValorPago').textContent = pago.toFixed(2);
                    document.getElementById('pagamentoValorPendente').textContent = pendente.toFixed(2);
                    document.getElementById('maxValorPagamento').textContent = pendente.toFixed(2);
                    
                    // Define o valor máximo do pagamento como o saldo pendente
                    const inputValorPagamento = document.getElementById('valorPagamento');
                    inputValorPagamento.max = pendente;
                    inputValorPagamento.value = pendente;
                    
                    // Abre o modal de pagamento
                    const modalPagamento = new bootstrap.Modal(document.getElementById('modalPagamento'));
                    modalPagamento.show();
                });
            });
        }
        
        // Confirmar cancelamento de reserva
        document.getElementById('btnConfirmarCancelamento').addEventListener('click', function() {
            const codigo = document.getElementById('cancelarCodigo').value;
            const motivo = document.getElementById('motivoCancelamento').value.trim();
            
            if (!motivo) {
                alert('Por favor, informe o motivo do cancelamento.');
                return;
            }
            
            // Envia requisição para cancelar a reserva
            fetch('/reservas/cancelar-reserva-ajax/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    codigo: codigo,
                    motivo: motivo
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Fecha o modal
                    bootstrap.Modal.getInstance(document.getElementById('modalCancelar')).hide();
                    bootstrap.Modal.getInstance(document.getElementById('modalDetalhes')).hide();
                    
                    // Exibe mensagem de sucesso
                    mostrarAlerta('Reserva cancelada com sucesso!', 'success');
                    
                    // Recarrega o calendário
                    calendar.refetchEvents();
                } else {
                    alert('Erro ao cancelar reserva: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao cancelar reserva. Verifique o console para mais detalhes.');
            });
        });
        
        // Confirmar checkout
        document.getElementById('btnConfirmarCheckout').addEventListener('click', function() {
            const codigo = document.getElementById('checkoutCodigo').value;
            const observacoes = document.getElementById('observacoesCheckout').value;
            
            // Envia requisição para realizar o checkout
            fetch('/reservas/checkout-reserva-ajax/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    codigo: codigo,
                    observacoes: observacoes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Fecha os modais
                    bootstrap.Modal.getInstance(document.getElementById('modalCheckout')).hide();
                    bootstrap.Modal.getInstance(document.getElementById('modalDetalhes')).hide();
                    
                    // Exibe mensagem de sucesso
                    mostrarAlerta('Check-out realizado com sucesso!', 'success');
                    
                    // Recarrega o calendário
                    calendar.refetchEvents();
                } else {
                    alert('Erro ao realizar check-out: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao realizar check-out. Verifique o console para mais detalhes.');
            });
        });
        
        // Confirmar pagamento
        document.getElementById('btnConfirmarPagamento').addEventListener('click', function() {
            const codigo = document.getElementById('pagamentoCodigoReserva').value;
            const valor = document.getElementById('valorPagamento').value;
            const metodo = document.getElementById('formaPagamento').value;
            const observacoes = document.getElementById('observacoesPagamento').value;
            
            // Validações básicas
            if (!valor || parseFloat(valor) <= 0) {
                alert('Por favor, informe um valor válido para o pagamento.');
                return;
            }
            
            if (!metodo) {
                alert('Por favor, selecione uma forma de pagamento.');
                return;
            }
            
            // Envia requisição para registrar o pagamento
            fetch('/reservas/registrar-pagamento-ajax/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    codigo: codigo,
                    valor: valor,
                    metodo_pagamento: metodo,
                    observacoes: observacoes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Fecha o modal
                    bootstrap.Modal.getInstance(document.getElementById('modalPagamento')).hide();
                    
                    // Exibe mensagem de sucesso
                    mostrarAlerta('Pagamento registrado com sucesso!', 'success');
                    
                    // Recarrega o calendário
                    calendar.refetchEvents();
                } else {
                    alert('Erro ao registrar pagamento: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao registrar pagamento. Verifique o console para mais detalhes.');
            });
        });
        
        // Obter CSRF Token
        function getCsrfToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }
            return '';
        }
        
        // Mostrar alerta de sucesso/erro
        function mostrarAlerta(mensagem, tipo) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo} alert-dismissible fade show fixed-top mx-auto mt-3`;
            alertDiv.style.width = '80%';
            alertDiv.style.maxWidth = '500px';
            alertDiv.style.zIndex = '9999';
            
            alertDiv.innerHTML = `
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Remove o alerta após 5 segundos
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => {
                    alertDiv.remove();
                }, 300);
            }, 5000);
        }
        
        // Função para destacar dias com reservas
        function destacarDiasComReservas() {
            // Obtém o mês atual exibido
            const viewInfo = calendar.view;
            const startDate = viewInfo.activeStart;
            const endDate = viewInfo.activeEnd;
            
            // Formata as datas para a requisição
            const startStr = startDate.toISOString().split('T')[0];
            const endStr = endDate.toISOString().split('T')[0];
            
            // Faz a requisição para obter os dias com reservas
            fetch(`/reservas/dias-com-reservas/?start=${startStr}&end=${endStr}`)
                .then(response => response.json())
                .then(data => {
                    if (data.dias && data.dias.length > 0) {
                        // Limpa qualquer destacamento anterior
                        document.querySelectorAll('.reservation-count').forEach(el => el.remove());
                        document.querySelectorAll('.has-reservations').forEach(el => {
                            el.classList.remove('has-reservations');
                        });
                        
                        // Para cada dia com reservas
                        data.dias.forEach(dia => {
                            // Encontra a célula do calendário para este dia
                            const dataStr = dia.data;
                            const celulaDay = document.querySelector(`.fc-day[data-date="${dataStr}"]`);
                            
                            if (celulaDay) {
                                // Adiciona classe para destacar visualmente
                                celulaDay.classList.add('has-reservations');
                                
                                // Adiciona badge com a quantidade
                                const badge = document.createElement('div');
                                badge.className = 'reservation-count';
                                badge.textContent = dia.quantidade;
                                celulaDay.appendChild(badge);
                            }
                        });
                    }
                })
                .catch(error => console.error('Erro ao destacar dias com reservas:', error));
        }
        
        // Registra evento para rodar a função quando o calendário mudar de mês
        calendar.on('datesSet', function() {
            destacarDiasComReservas();
        });
    });
</script>

<style>
.tooltip-content {
    text-align: left;
    max-width: 300px;
}
.tooltip-content h6 {
    margin-bottom: 0.5rem;
    color: #fff;
}
.tooltip-content p {
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
}
</style>
{% endblock %} 