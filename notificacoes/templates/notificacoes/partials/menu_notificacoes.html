{% load static %}
<div class="dropdown-menu dropdown-menu-end dropdown-menu-lg py-0" aria-labelledby="notificacoesBotao">
    <div class="dropdown-menu-header position-relative bg-primary py-2 px-3 d-flex justify-content-between align-items-center">
        <span class="text-white"><i class="fas fa-bell me-1"></i> Notificações</span>
        <span class="badge bg-danger rounded-pill">{{ total }}</span>
    </div>
    
    <div class="dropdown-divider m-0"></div>
    
    <div class="categorias-badges text-center py-2">
        {% for nome, categoria in categorias.items %}
            {% if categoria.count > 0 %}
                <a href="{% url 'notificacoes:listar' %}?categoria={{ nome }}" class="mx-1">
                    <span class="badge bg-{{ categoria.color }} position-relative">
                        <i class="fas fa-{{ categoria.icon }}"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem;">
                            {{ categoria.count }}
                        </span>
                    </span>
                </a>
            {% endif %}
        {% endfor %}
    </div>
    
    <div class="dropdown-divider m-0"></div>
    
    <div class="notificacoes-list">
        {% if notificacoes %}
            {% for notificacao in notificacoes %}
                <a href="{% if notificacao.url_acao %}{{ notificacao.url_acao }}{% else %}#{% endif %}" class="dropdown-item {% if notificacao.tipo == 'info' %}text-info{% elif notificacao.tipo == 'success' %}text-success{% elif notificacao.tipo == 'warning' %}text-warning{% elif notificacao.tipo == 'danger' %}text-danger{% endif %}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            {% if notificacao.categoria == 'reserva' %}
                                <i class="fas fa-calendar-alt me-2"></i>
                            {% elif notificacao.categoria == 'pagamento' %}
                                <i class="fas fa-money-bill-wave me-2"></i>
                            {% elif notificacao.categoria == 'hospede' %}
                                <i class="fas fa-user me-2"></i>
                            {% elif notificacao.categoria == 'quarto' %}
                                <i class="fas fa-bed me-2"></i>
                            {% else %}
                                <i class="fas fa-cog me-2"></i>
                            {% endif %}
                            <strong>{{ notificacao.titulo }}</strong>
                        </div>
                        <small class="text-muted">{{ notificacao.data_criacao|date:"d/m/Y H:i" }}</small>
                    </div>
                    <p class="mb-0 small">{{ notificacao.mensagem|truncatechars:60 }}</p>
                </a>
                <div class="dropdown-divider m-0"></div>
            {% endfor %}
        {% else %}
            <div class="text-center py-3">
                <p class="mb-0 text-muted">Não há notificações novas</p>
            </div>
            <div class="dropdown-divider m-0"></div>
        {% endif %}
    </div>
    
    <div class="dropdown-menu-footer bg-light py-2">
        <div class="d-flex justify-content-between">
            <a href="{% url 'notificacoes:listar' %}" class="btn btn-sm btn-primary">
                <i class="fas fa-list me-1"></i> Ver todas
            </a>
            {% if total > 0 %}
                <a href="{% url 'notificacoes:marcar_como_lida' 0 %}" 
                   class="btn btn-sm btn-secondary marcar-todas-lidas" 
                   data-bs-toggle="tooltip" 
                   title="Marcar todas como lidas">
                    <i class="fas fa-check-double"></i>
                </a>
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Marcar todas como lidas
        var btnMarcarTodas = document.querySelector('.marcar-todas-lidas');
        if (btnMarcarTodas) {
            btnMarcarTodas.addEventListener('click', function(e) {
                e.preventDefault();
                var url = this.getAttribute('href');
                
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    }
                });
            });
        }
        
        // Função para obter cookie CSRF
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script> 